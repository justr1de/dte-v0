name: Checklist Validation

on:
  pull_request:
    types: [opened, edited, synchronize]

jobs:
  validate-checklist:
    name: Validar Checklist Obrigat√≥rio
    runs-on: ubuntu-latest
    
    steps:
      - name: Verificar Checklist do PR
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.pull_request.body || '';
            
            // Itens obrigat√≥rios do checklist (pelo menos um de cada se√ß√£o deve estar marcado)
            const sections = {
              'Valida√ß√£o de Requisitos': [
                'Sistema de autentica√ß√£o confirmado',
                'Arquitetura validada',
                'Integra√ß√µes existentes identificadas',
                'Requisitos documentados por escrito',
                'N√ÉO foi usado template padr√£o sem valida√ß√£o'
              ],
              'Backup e Seguran√ßa': [
                'Backup criado para arquivos de autentica√ß√£o',
                'Backup criado para configura√ß√µes de banco',
                'Backup criado para vari√°veis de ambiente',
                'Estado funcional atual do sistema documentado',
                'Altera√ß√µes testadas em ambiente isolado'
              ]
            };
            
            let errors = [];
            let warnings = [];
            
            // Verificar se o corpo do PR existe
            if (!body || body.trim() === '') {
              core.setFailed('‚ùå O PR n√£o possui descri√ß√£o. Por favor, preencha o template com o checklist obrigat√≥rio.');
              return;
            }
            
            // Verificar se√ß√£o de Valida√ß√£o de Requisitos
            const validacaoItems = sections['Valida√ß√£o de Requisitos'];
            const validacaoMarcados = validacaoItems.filter(item => 
              body.includes(`[x] ${item}`) || body.includes(`[X] ${item}`)
            );
            
            if (validacaoMarcados.length === 0) {
              errors.push('Se√ß√£o "Valida√ß√£o de Requisitos": Nenhum item foi marcado');
            } else if (validacaoMarcados.length < 3) {
              warnings.push(`Se√ß√£o "Valida√ß√£o de Requisitos": Apenas ${validacaoMarcados.length} de 5 itens marcados`);
            }
            
            // Verificar arquivos cr√≠ticos modificados
            const arquivosCriticos = [
              'AuthContext',
              'supabase.ts',
              '.env',
              'config'
            ];
            
            // Se arquivos cr√≠ticos foram modificados, backup √© obrigat√≥rio
            const modificouCriticos = body.includes('[x] `AuthContext.tsx`') || 
                                      body.includes('[x] `supabase.ts`') ||
                                      body.includes('[x] `.env`') ||
                                      body.includes('[x] Arquivos de configura√ß√£o');
            
            if (modificouCriticos) {
              const backupItems = sections['Backup e Seguran√ßa'];
              const backupMarcados = backupItems.filter(item => 
                body.includes(`[x] ${item}`) || body.includes(`[X] ${item}`)
              );
              
              if (backupMarcados.length < 2) {
                errors.push('Arquivos cr√≠ticos foram modificados, mas o checklist de Backup n√£o foi preenchido adequadamente');
              }
            }
            
            // Verificar se √© corre√ß√£o de bug
            const ehCorrecaoBug = body.includes('[x] Corre√ß√£o de bug');
            if (ehCorrecaoBug) {
              const diagnosticoOk = body.includes('[x] Causa raiz identificada') || 
                                    body.includes('[x] Diferen√ßas entre ambiente local');
              if (!diagnosticoOk) {
                warnings.push('Corre√ß√£o de bug detectada, mas checklist de Diagn√≥stico n√£o foi preenchido');
              }
            }
            
            // Gerar relat√≥rio
            let report = '## üìã Relat√≥rio de Valida√ß√£o do Checklist\n\n';
            
            if (errors.length > 0) {
              report += '### ‚ùå Erros (bloqueiam o merge)\n';
              errors.forEach(e => report += `- ${e}\n`);
              report += '\n';
            }
            
            if (warnings.length > 0) {
              report += '### ‚ö†Ô∏è Avisos\n';
              warnings.forEach(w => report += `- ${w}\n`);
              report += '\n';
            }
            
            if (errors.length === 0 && warnings.length === 0) {
              report += '### ‚úÖ Checklist validado com sucesso!\n';
              report += 'Todos os itens obrigat√≥rios foram preenchidos.\n';
            }
            
            // Postar coment√°rio no PR
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: report
            });
            
            // Falhar se houver erros
            if (errors.length > 0) {
              core.setFailed(`‚ùå Checklist incompleto: ${errors.join('; ')}`);
            }

  check-critical-files:
    name: Verificar Arquivos Cr√≠ticos
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Listar arquivos modificados
        id: files
        run: |
          FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | tr '\n' ' ')
          echo "modified=$FILES" >> $GITHUB_OUTPUT
          
      - name: Alertar sobre arquivos cr√≠ticos
        uses: actions/github-script@v7
        env:
          MODIFIED_FILES: ${{ steps.files.outputs.modified }}
        with:
          script: |
            const files = process.env.MODIFIED_FILES.split(' ').filter(f => f);
            
            const criticalPatterns = [
              { pattern: /AuthContext/i, name: 'Autentica√ß√£o (AuthContext)' },
              { pattern: /supabase/i, name: 'Banco de Dados (Supabase)' },
              { pattern: /\.env/i, name: 'Vari√°veis de Ambiente' },
              { pattern: /config\.(ts|js)/i, name: 'Configura√ß√£o' }
            ];
            
            const criticalFiles = [];
            
            for (const file of files) {
              for (const { pattern, name } of criticalPatterns) {
                if (pattern.test(file)) {
                  criticalFiles.push({ file, category: name });
                }
              }
            }
            
            if (criticalFiles.length > 0) {
              let warning = '## ‚ö†Ô∏è Arquivos Cr√≠ticos Detectados\n\n';
              warning += 'Os seguintes arquivos cr√≠ticos foram modificados neste PR:\n\n';
              warning += '| Arquivo | Categoria |\n';
              warning += '|---------|----------|\n';
              criticalFiles.forEach(({ file, category }) => {
                warning += `| \`${file}\` | ${category} |\n`;
              });
              warning += '\n**Certifique-se de que:**\n';
              warning += '1. Foi criado backup antes das altera√ß√µes\n';
              warning += '2. As altera√ß√µes foram testadas em ambiente isolado\n';
              warning += '3. O checklist de Backup e Seguran√ßa est√° preenchido\n';
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: warning
              });
            }
